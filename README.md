SHEDS Brook Trout Occupancy Model
=================================

Jeffrey D. Walker, PhD  
[Walker Environmental Research LLC](https://walkerenvres.com/)

Ben Letcher, PhD  
[USGS](https://www.lsc.usgs.gov/?q=cafb-research), [UMass](https://eco.umass.edu/people/faculty/letcher-ben/)

Dan Hocking, PhD  
[Frostburg State University](http://hockinglab.weebly.com/)

*Adapted from*: [Conte-Ecology/Northeast_Bkt_Occupancy](https://github.com/Conte-Ecology/Northeast_Bkt_Occupancy).

## About

This repo contains the source code for the [SHEDS Brook Trout Occupancy model](http://ecosheds.org/models/brook-trout-occupancy/latest).


## Quick Start

To set up and run the SHEDS Brook Trout Occupancy model, follow these steps:

1. Set up [Configuration File](#configuration)
2. Set version number in [Version File](#versioning)
3. Create [Working Directory](#working-directory)
4. [Run the Model](#model-execution)
5. Upload [Results](#results)
6. Update [Documentation](#documentation)

Each of these steps are described in more detail in the following sections.


## Configuration

The R scripts use the `config` package to load a set of configuration variables from the `config.yml` file.

Because some of these variables contain sensitive information (e.g. database password) or variables that will be unique to the user's local file system (e.g. model root path), the `config.yml` file is not tracked by git.

Therefore, after cloning the repo, the user must create this file manually using the following template:

```yml
default:
  root: "/path/to/bto-model-data/"
  db:
    host: ecosheds.org
    port: 5432
    user: jeff
    password: mochabeanhalocoffee
    dbname: sheds
```

The `root` variable defines the path to the model data directory, which is typically outside of this repo (model inputs/outputs should not be tracked by git).

The `db` variable defines the SHEDS database connection parameters.


## Versioning

The model versioning approach is loosely based on [semantic versioning](https://semver.org/).

Each version contains three numbers of the form `X.Y.Z`:

- `X`: Major version incremented when there is a major change to the underlying model theory or code.
- `Y`: Minor version incremented when a new set of model inputs and outputs are created. This can either be due to an update of the input datasets or a (minor) change in the code.
- `Z`: Patch version incremented when there is a minor change to the documentation or output files, but no change to the model calibration or prediction datasets.

The full version therefore is used to track changes to both the model and the documentation. Model calibration and results do not change between minor versions (`X.Y`).

The model version is defined in the `version.yml` file, which follows this template:

```yml
default:
  bto: X.Y.Z
  tempmodel: X.Y.Z
```

This file defines the version of the brook trout occupancy model (`bto`) and also the version of the stream temperature model (`tempmodel`) used as input to the BTO model.

The `bto` version can be set to any string, because it is simply used to generate the model [working directory](#working-directory). During development, for example, the version could be set to `1.0-dev`.

The `version.yml` file is tracked by git to ensure the model version coincides with model source code. Any changes to the model code should be associated with a change to the version number.

When a new version of the model is complete, a tagged release should be created in github with the full version of the model (`vX.Y.Z`), and a title containing both the version and the date (e.g. `vX.Y.Z (MMM DD, YYYY)`).


## Working Directory

In order to transfer data from one script to another, all of the scripts save and load data from a common directory. This directory is referred to as the model's working directory, but should **NOT** be confused with the working directory used by R (i.e. `getwd()`), which is the directory from which the scripts are run and is typically the root of this repo. In other words, the model's working directory stores the data files, while R's working directory contains the source scripts.

The path to the model's working directory is automatically generated by combining a model root path and the model version (i.e. `/<root path>/<bto version>`). The root path therefore can contain one of more sub-directories, each of which is the working directory for a specific version of the model.

The root directory should therefore look something like this:

```
$ tree ${bto_version}

├── 0.9
|   ├── ...
└── 1.0
    ├── bto-model.log
    ├── data-covariates.rds
    ├── data-huc.rds
    ├── data-obs.rds
    ├── data-temp.rds
    ├── model-calib.rds
    ├── model-input.rds
    ├── model-predict.csv
    ├── model-predict.rds
    └── model-valid.rds
```

The root path and model version are set using two environment variables:

- `root`: within the `config.yml` file (see [Configuration](#configuration)), this variable should be set to a local path that serves as the root directory for all model versions (e.g. `/path/to/bto-model-data`), which should not outside of this repo.
- `bto`: within the `version.yml` file (see [Model Version](#versioning)), this variable should be set to a unique model version.

The `load_config()` R function (defined in `src/functions.R`) will combine these two variables to create a complete path to the current model working directory, which is set to the `wd` element of the list returned from the function.

Here is an example of how these files work together:

```
# config.yml
root: /path/to/bto-model-data

# version.yml
bto: 1.0

# R
> source("functions.R")
> config <- load_config()
> print(config$wd)
[1] "/path/to/bto-model-data/1.0"
```

The `config$wd` path is then used throughout the various R scripts to load and save data from a single directory.

:heavy_exclamation_mark: **Important** When creating a new model version, the user must manually create the working directory on their file system. The `load_config()` will return an error if it cannot find the working directory, in which case you simply need to create it and try again.


## Model Execution

The BTO model is run by executing a series of R scripts located in the `src/` directory.

These scripts comprise a chain of tasks -- each script performs one of these tasks such as fetching raw input data, merging datasets to generate a model input dataset, calibrating the model, or generating predictions.

The scripts must be run a specific order to ensure all inputs for a given script have already by generated by previous scripts. The scripts are listed in order and explained in `src/model.R`.

In theory, one could execute `model.R` to run all the R scripts sequentially after completing steps 1-3 in [Quick Start](#quick-start).

```
Rscript src/main.R
```

:heavy_exclamation_mark: **Remember** to change the model version within `version.sh` to create the working directory prior to running this script or you will overwrite previous results.

In practice, it's better to run each script interactively within RStudio to check the calculations and outputs.


## Results

The derived metrics for each catchment are exported to:

1. database table `bto_model` (via `src/export/db.R`)
2. CSV file `csv/sheds-bto-model-v{version}.csv` (via `db/export/csv.R`)

After completing the model run, the output CSV file should be copied to the server within the `www/static/models/bto-model/output` folder.


## Documentation

After running all of the model scripts, the model documentation should be updated.

The documentation is written using the [`bookdown` package](https://bookdown.org/yihui/bookdown/), and located within the `docs` sub-directory.

The home page for the documentation is written in the `index.Rmd` file. The remaining sections are each written within their own R markdown file (e.g. `01-theory.Rmd`).

The documentation can be generated from the source Rmd files using the `Build Book` button within the `Build` pane in RStudio. Alternatively, the following command can be used:

```
rmarkdown::render_site(encoding = 'UTF-8')
```

The static output files (i.e. static HTML, CSS, and JavaScript) can be found within the `docs/_book` sub-directory.

After the full documentation is initially generated, individual sections can be edited and re-rendered using the `Knit` button in RStudio, similar to rendering individual Rmd files.

When documentation for the current model version is complete, the static output files in `docs/_book` can be copied to the appropriate location on the web server using FTP, scp or some other transfer protocol.
